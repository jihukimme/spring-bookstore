<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<head>
    <title th:text="${book.title} + ' - BookStore24'">도서 상세 - BookStore24</title>
</head>
<body>
    <main th:replace="~{layout/base :: content}">
        <div class="container mt-4">
            <!-- Success/Error Messages -->
            <div class="alert alert-success alert-dismissible fade show" th:if="${success}" role="alert">
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div class="alert alert-danger alert-dismissible fade show" th:if="${error}" role="alert">
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div class="row">
                <!-- Book Details -->
                <div class="col-md-4">
                    <img th:src="${book.imageUrl != null ? book.imageUrl : '/images/book-placeholder.jpg'}" 
                         class="img-fluid rounded shadow" th:alt="${book.title}">
                </div>
                
                <div class="col-md-8">
                    <h1 th:text="${book.title}">도서 제목</h1>
                    <p class="text-muted mb-2">
                        <strong>저자:</strong> <span th:text="${book.author}">저자명</span>
                    </p>
                    <p class="text-muted mb-2">
                        <strong>출판사:</strong> <span th:text="${book.publisher}">출판사명</span>
                    </p>
                    <p class="text-muted mb-2">
                        <strong>ISBN:</strong> <span th:text="${book.isbn}">ISBN</span>
                    </p>
                    
                    <!-- Rating -->
                    <div class="mb-3" th:if="${avgRating != null}">
                        <div class="rating">
                            <span th:each="i : ${#numbers.sequence(1, 5)}">
                                <i class="fas fa-star" th:if="${i <= avgRating}"></i>
                                <i class="far fa-star" th:unless="${i <= avgRating}"></i>
                            </span>
                            <span class="ms-2" th:text="${#numbers.formatDecimal(avgRating, 1, 1)} + ' (' + ${reviewCount} + '개 리뷰)'">4.5 (10개 리뷰)</span>
                        </div>
                    </div>
                    
                    <!-- Price -->
                    <h3 class="price mb-3" th:text="${#numbers.formatInteger(book.price, 0, 'COMMA')} + '원'">15,000원</h3>
                    
                    <!-- Stock Status -->
                    <div class="mb-3">
                        <span class="badge bg-success" th:if="${book.stockQuantity > 0}">재고 있음</span>
                        <span class="badge bg-danger" th:unless="${book.stockQuantity > 0}">품절</span>
                        <small class="text-muted ms-2" th:text="'재고: ' + ${book.stockQuantity} + '권'">재고: 10권</small>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4" th:if="${book.description}">
                        <h5>도서 소개</h5>
                        <p th:text="${book.description}">도서 설명</p>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex">
                        <form th:action="@{/cart/add}" method="post" class="me-md-2">
                            <input type="hidden" name="bookId" th:value="${book.id}">
                            <input type="hidden" name="quantity" value="1">
                            <button type="submit" class="btn btn-primary btn-lg" th:disabled="${book.stockQuantity <= 0}">
                                <i class="fas fa-cart-plus me-2"></i>장바구니 담기
                            </button>
                        </form>
                        
                        <button type="button" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-heart me-2"></i>찜하기
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Reviews Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <h3>리뷰 <small class="text-muted">(<span th:text="${reviewCount}">0</span>개)</small></h3>
                    
                    <!-- Review Form -->
                    <div class="card mb-4" th:if="${session.user != null and canReview}">
                        <div class="card-header">
                            <h5 class="mb-0">리뷰 작성</h5>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/reviews/add}" method="post" th:object="${newReview}">
                                <input type="hidden" th:field="*{bookId}" th:value="${book.id}">
                                
                                <div class="mb-3">
                                    <label class="form-label">평점</label>
                                    <div class="rating-input">
                                        <input type="radio" th:field="*{rating}" value="5" id="star5">
                                        <label for="star5"><i class="fas fa-star"></i></label>
                                        <input type="radio" th:field="*{rating}" value="4" id="star4">
                                        <label for="star4"><i class="fas fa-star"></i></label>
                                        <input type="radio" th:field="*{rating}" value="3" id="star3">
                                        <label for="star3"><i class="fas fa-star"></i></label>
                                        <input type="radio" th:field="*{rating}" value="2" id="star2">
                                        <label for="star2"><i class="fas fa-star"></i></label>
                                        <input type="radio" th:field="*{rating}" value="1" id="star1">
                                        <label for="star1"><i class="fas fa-star"></i></label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="content" class="form-label">리뷰 내용</label>
                                    <textarea class="form-control" id="content" th:field="*{content}" rows="4" 
                                              placeholder="이 도서에 대한 솔직한 리뷰를 작성해주세요." required></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-pen me-2"></i>리뷰 등록
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Login prompt for non-logged users -->
                    <div class="alert alert-info" th:if="${session.user == null}">
                        <i class="fas fa-info-circle me-2"></i>
                        리뷰를 작성하려면 <a th:href="@{/login}" class="alert-link">로그인</a>이 필요합니다.
                    </div>
                    
                    <!-- Already reviewed message -->
                    <div class="alert alert-warning" th:if="${session.user != null and !canReview}">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        이미 이 도서에 대한 리뷰를 작성하셨습니다.
                    </div>
                    
                    <!-- Reviews List -->
                    <div th:if="${reviews.empty}" class="text-center py-4">
                        <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">아직 리뷰가 없습니다</h5>
                        <p class="text-muted">첫 번째 리뷰를 작성해보세요!</p>
                    </div>
                    
                    <div th:unless="${reviews.empty}">
                        <div class="card mb-3" th:each="review : ${reviews}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title" th:text="${review.userName}">사용자명</h6>
                                        <div class="rating mb-2">
                                            <span th:each="i : ${#numbers.sequence(1, 5)}">
                                                <i class="fas fa-star" th:if="${i <= review.rating}"></i>
                                                <i class="far fa-star" th:unless="${i <= review.rating}"></i>
                                            </span>
                                            <small class="text-muted ms-1" th:text="${review.rating} + '/5'">5/5</small>
                                        </div>
                                        <p class="card-text" th:text="${review.content}">리뷰 내용</p>
                                        <small class="text-muted" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</small>
                                    </div>
                                    
                                    <!-- Delete button for own reviews -->
                                    <div th:if="${session.user != null and session.user.id == review.userId}">
                                        <form th:action="@{/reviews/{id}/delete(id=${review.id})}" method="post" class="d-inline"
                                              onsubmit="return confirm('정말로 이 리뷰를 삭제하시겠습니까?')">
                                            <input type="hidden" name="bookId" th:value="${book.id}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <style>
        .rating-input {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }
        
        .rating-input input {
            display: none;
        }
        
        .rating-input label {
            color: #ddd;
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .rating-input input:checked ~ label,
        .rating-input label:hover,
        .rating-input label:hover ~ label {
            color: #ffc107;
        }
    </style>
</body>
</html>
